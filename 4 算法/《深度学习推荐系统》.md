# 推荐序

作为个性化时代互联网的核心应用技术，推荐、搜索和广告一直是工业界技术研发与创新的主战场，也是巨头公司如谷歌、亚马逊、阿里巴巴等重兵投人打造的技术护城河。这些领域往往面对的是互联网尺度的问题，非线性复杂度高，且容易收集到大量的数据，天然适合数据驱动（data-driven）的方法。2015年左右，深度学习的技术浪潮席卷进来，迅速引爆了整个领域的全面技术变革。

对于追求实效的工业界来说，深度学习带来的价值远不止贡献了一种新的算法。回顾整个互联网技术的发展史，机器学习作为一种新的生产工具，很早就被引人，并被应用在搜索、广告等领域。只不过，早期学术界研究、发表的大量复杂算法模型，往往只能停留在实验室阶段，难以被工业界大规模应用。主要原因有两个：一是模型的假设过于苛刻，跟真实应用情况相差很远，效果难以保证；二是工业界计算规模巨大，模型的训练和求解都存在复杂的工程挑战。一个新的模型从设计到应用，往往需要专业的大规模并行计算团队动辄数月甚至数年的时间才能研发成功。那个时期，工业界跟学术界交集很少。

然而，深度学习的出现彻底改变了技术研发的格局，推动生产力出现了数量级的跃升一。与传统机器学习不同的是，深度学习将复杂的、需要专业化建模与优化能力、专业化分布式计算编程能力才能搞定的工业级机器学习算法研发闭环打破，提供了如下搭积木式的算法研发新范式：

(1)大量优秀且开源的深度学习训练框架提供了封装好的基础模块，新模型算法的设计变成了工具化组装。

(2)深度模型的优化可以采用一系列标准的优化器轻松完成，无须人工进行梯度的求导及优化算法的设计，且大部分优化器已经嵌人在深度学习框架中，无须编程开发。

(3）算法工程师或科学家可以将主要研发精力集中到对领域问题的理解和模型设计，通过类似土木工程师绘图的方式搭建深度模型架构图，接下来的工作交给软件工程师，通过对深度学习框架计算效率和性能的优化，即可完成模型的训练。换句话说，模型的设计和实现是解藕的。

这种全新的研发模式，使得深度学习时代新模型、新算法的研发与创新层出不穷，极大地推高了工业应用领域的技术水位，带来了真金白银的巨大价值。如今，一名技术实习生每天可以轻松完成数个深度模型算法的实验尝试，而在之前的数十年间，能被工业界应用的机器学习模型屈指可数，这是巨大的生产力提升。可以说，深度学习解放了工业界对于复杂机器学习模型应用的畏‘俱心和想象力。

研发模式的变革，进一步重塑了技术创新的内驱力。我们可以清晰地看到，深度学习浪潮爆发后，在推荐、搜索、广告这类应用技术领域，核心模型算法的创新已经逐渐演变成由工业界主导、以工业实践和领域应用驱动为主的模式。最领先的算法往往来自头部公司的顶尖团队，而不再由学术界专门做研究的机器学习实验室基于假想的问题或理论的发展而创造。

这些来自工业界的算法，往往带有极强的领域问题色彩，抛开了漂亮的理论外表，追求简洁务实。而这一点，恰恰是年轻的从业者容易忽视的。这也是本书最为珍贵的闪光点。它最大的价值不是罗列了众多的、闻名业界的典型模型算法进行细节点解剖，而是从技术创造的视角，以具体的技术诞生场景为蓝图，试图引导读者学习和掌握工业界模型设计背后的真正“银弹”―目的是解决什么样的问题。

当前，工业界技术研发圈普遍存在两种方法体系：

(1)拿着锤子找钉子：跟踪最新的顶会论文或大公司技术博客，寻找创新点，拿到自己的场景试一试，靠撞大运拿结果。

(2）问题驱动：定义清楚问题，想清楚技术的需求，然后寻找或构思相应的技术工具。

很可惜的是，当前业界很多技术团队或者算法工程师，还是习惯于使用第一种研发方法，不是能力不足，而是思维惯性和缺乏技术自信所致。这里以我领导的阿里巴巴定向广告模型团队的研发路径为例，对第二种研发方法做介绍：

我们一直在思考和寻找的是“真正能够发挥阿里巴巴电商体系下大量沉淀的互联网个性化行为数据”的模型算法。在这样的思路下，在过去的三、四年里，我们创造性地提出・研发及生产化了DIN、 DIEN、 MIMN、 ESMM等一系列个性化行为预估模型，为阿里广告业务带来了百亿级收入增量。这些模型背后有两条思考的主线：

(1)以电商场景为代表的这类互联网个性化行为模式，用何种深度模型结构来捕捉其内在规律。因此读者看到了我们将Attention式结构（反向激活用户兴趣表达，见DIN模型）、GRU式结构（兴趣随时间演化规律，见DIEN模型）、 Memory式结构（兴趣记忆与归纳，见MIMN模型）等引入模型设计中。

(2)用户行为数据使用得越多，对用户兴趣的刻画越准确，用何种技术架构来容纳更多的数据。因此读者看到我们从单点行为建模（DIN、 DIEN、 MIMN)发展了多种行为路径的联合建模（ESMM)、从短序列行为数据建模（DIN、 DIEN)发展为超长行为序列建模（MIMN )。

深度学习的技术浪潮，从爆发到今天成为工业界绝大部分公司的标配解法，事实上第一波直接的技术红利已经基本被消耗殆尽。据我所知，业界大部分头部的、深度学习变革较为彻底的团队，都已经进人到滞涨阶段。这段技术发展过程，我称之为工业级深度学习1.0阶段。1.0阶段达到顶峰的标志是：

(1)搭积木式的模型架构演进，其边际收益越来越低。

(2)深度模型进人数据饥饿阶段，希望进一步通过10倍、100倍的数据量来填充既有模型容量（model capacity)，从而提升精度。

(3)大部分新的大型算法优化和改进，都需要工程系统架构配套进行巨大的升级改造。

瓶颈已经出现，新的技术跃变在何方？

从2018年开始，我判断、践行并一直呼吁：**对于推荐、搜索及广告等领域，业界需要重新定义和设计新的系统架构，以适应深度学习爆发式发展带来的领先算法能力**。我认为，下一步技术的演化会进人全新的阶段，我称之为工业级深度学习2.0阶段。在2.0阶段，深度学习不再是新奇的利器，而是新的基础设施（工具）；算力不再是深度学习的助推力，相反地由于模型复杂度的爆炸，算力将变成新的制约；技术发展将从依赖深度学习算法单点突破收割技术红利，开始转向更为复杂的、系统性的技术体系推进，进一步创造技术红利。这里，关键性的技术破局点是算法与系统架构的协同设计（algo-system co-design)。举一个具体的例子：粗排一直是推荐、广告等排序技术系统中的重要一环，受计算规模远超精排的限制，历史上粗排模型经历了从最简单的统计反馈模型，发展到特征裁剪下的轻量级LR或FM模型，以及当前主流的双塔深度学习模型。然而，双塔结构限定了用户侧与物品侧没法进行特征交叉，且最终的目标拟合只能是向量内积及相关变种形式，模型的表达能力大大受限。2019年，我们团队做了一次大胆而全新的尝试：重新定义了粗排架构，采用全实时计算的方式，引人网络量化压缩、蒸馏等技术，对算力与模型精度进行了精细化平衡，在一定的算力约束下可以支持粗排模型采用任意复杂度的深度网络结构进行在线推理。这种架构使得我们最新的粗排模型几乎可以逼近精排最复杂的模型，而且支持高效的线上迭代，在绝大部分场景上线后均取得了两位数以上的效果提升（这是我们近一年来单点模型技术提升最大的一项技术突破）。

可以预见，在工业级深度学习2.0阶段，技术演进的模式将再升级：从算法视角的实践和问题驱动，进一步拓展到更宏大的技术体系整体思考：领域问题特性、数据、算力、算法、架构及工程系统等将被纳人统一的思考框架中，成为技术创新的发力点。具体到推荐、搜索和广告领域的从业人员：算法工程师必须要兼顾系统工程师思维，系统工程师必须紧跟算法大潮并尝试引领算法架构。这个阶段的技术看起来“很不讨喜”：复杂、成本高、难复现、对人的要求高（算法能力＋工程能力双肩挑），等等。不过我认为，从简单到复杂，并进一步形成更简单的技术体系和浪潮，正是技术发展最深刻的规律，也是本书希望传达给读者的思考方式。

这是最好的时代，也是最坏的时代，借以此序与大家共勉。

朱小强

阿里巴巴资深算法专家

# 第1章 互联网的增长引擎—推荐系统

如果说推荐系统是互联网发展的增长引擎，那么推荐工程师就是推荐系统的发展引擎。

## 1 为什么推荐系统是互联网的增长引擎

对互联网从业者来说，“增长”这个词就像插在心中的一支矛，无时无刻不被其刺激并激励着。

### 推荐系统的作用和意义

- 用户角度：解决在“信息过载”的情况下，用户如何高效获得感兴趣信息的问题。
- 公司角度：解决产品能够最大限度地吸引用户、留存用户、增加用户黏性、提高用户转化率的问题，从而达到公司商业目标连续增长的目的。
  - 视频类公司：用户观看时长
  - 电商类公司：购买转化率
  - 新闻类公司：用户的点击率

### 推荐系统与YouTube的观看时长增长

YouTube推荐系统的主要优化目标就是观看时长，而非传统推荐系统看重的“点击率”。

### 推荐系统与电商网站的收入增长

2019年天猫“双11”的成交额是2684亿元。驱动天猫达成如此惊人成交额的是阿里巴巴著名的“千人千面”推荐系统。

## 2 推荐系统的架构

### 逻辑框架

在获知用户信息、物品信息、场景信息的基础上，推荐系统要处理的问题可以较形式化地定义为：对于用户U（user），在特定场景C（context）下，针对海量的”物品“信息，构建一个函数f(U, I, C)，预测用户对特定候选物品I（item）的喜好程度，再根据喜好程度对所有候选物品进行排序，生成推荐列表的问题。

### 技术架构

在图1-3的基础上，工程师需要着重解决的问题有两类：

- 数据和信息相关的问题，即用户信息、物品信息、场景信息分别是什么？如何存储、更新和处理？
- 推荐系统算法和模型相关的问题，即推荐模型如何训练、如何预测、如何达成更好的推荐效果？

### 数据部分

主要负责用户、物品、场景的信息收集与处理。具体地讲，将负责数据收集与处理的三种平台按照实时性的强弱排序，依次为：客户端及服务器端实时数据处理、流处理平台准实时数据处理、大数据平台离线数据处理。

在实时性由强到弱递减的同时，三种平台的海量数据处理能力能由弱到强。因此，一个成熟的推荐系统的数据流系统会将三者取长补短，配合使用。

在得到原始的数据信息后，推荐系统的数据处理系统会将原始数据进一步加工，加工后的数据出口主要有三个：

- 生成推荐模型所需的样本数据，用于算法模型的训练和评估。
- 生成推荐模型服务（model serving）所需的特征，用于推荐系统的线上推断。
- 生成系统监控、商业智能（Business Intelligence, BI）系统所需的统计型数据。

### 模型部分

- 召回层：一般利用高效的召回规则、算法或简单的模型，快速从海量的候选集中召回用户可能感兴趣的物品。
- 排序层：利用排序模型对初筛的候选集进行精排序。它是推荐系统产生效果的重点，也是业界和学界研究的重心。
- 补充策略与算法层：也被称为“再排序层”，可以在将推荐列表返回用户之前，为兼顾结果的多样性、流行度、新鲜度等指标，结合一些补充的策略和算法对推荐列表进行一定的调整，最终形成用户可见的推荐列表。

### 深度学习对推荐系统的革命性贡献

深度学习对推荐系统的革命性贡献在于**对推荐模型部分的改进**。与传统的推荐模型相比，深度学习模型对数据模式的拟合能力和对特征组合的挖掘能力更强。

## 3 本书的整体结构

本书的整体结构在图1-4的基础上展开，并重点介绍深度学习在推荐系统中的应用知识点和实践经验。在介绍具体的技术点时，笔者力图介绍清楚技术发展的主要脉络和前因后果。

由于推荐系统**排序模型**在推荐系统中占据绝对核心的地位，本书的前几章将着重介绍深度学习排序模型的技术演化趋势，在之后的章节中，会依次介绍推荐系统其他模块的技术细节和工程实现，通过业界前沿的推荐系统实例将所有知识融会贯通。

# 第2章 前深度学习时代—推荐系统的进化之路

## 1 传统推荐模型的演化关系图

## 2 协同过滤——经典的推荐算法

2.1 什么是协同过滤
2.2 用户相似度计算
2.3 终结果的排序
2.4 ItemCF
2.5 UserCF与ItemCF的应用场景
2.6 协同过滤的下一步发展

## 3 矩阵分解算法——协同过滤的进化

3.1 矩阵分解算法的原理
3.2 矩阵分解的求解过程
3.3 消除用户和物品打分的偏差
3.4 矩阵分解的优点和局限性

## 4 逻辑回归——融合多种特征的推荐模型

4.1 基于逻辑回归模型的推荐流程
4.2 逻辑回归模型的数学形式
4.3 逻辑回归模型的训练方法
4.4 逻辑回归模型的优势
4.5 逻辑回归模型的局限性

## 5 从FM到FFM——自动特征交叉的解决方案

5.1 POLY2模型——特征交叉的开始
5.2 FM模型——隐向量特征交叉
5.3 FFM模型——引入特征域的概念
5.4 从POLY2到FFM的模型演化过程

## 6 GBDT+LR——特征工程模型化的开端

6.1 GBDT+LR组合模型的结构
6.2 GBDT进行特征转换的过程
6.3 GBDT+LR 组合模型开启的特征工程新趋势

## 7 LS-PLM——阿里巴巴曾经的主流推荐模型

7.1 LS-PLM 模型的主要结构
7.2 LS-PLM模型的优点
7.3 从深度学习的角度重新审视LS-PLM模型

## 8 总结——深度学习推荐系统的前夜

# 第3章 浪潮之巅—深度学习在推荐系统中的应用

## 1 深度学习推荐模型的演化关系图

## 2 AutoRec——单隐层神经网络推荐模型

2.1 AutoRec模型的基本原理
2.2 AutoRec模型的结构
2.3 基于AutoRec模型的推荐过程
2.4 AutoRec模型的特点和局限性

## 3 Deep Crossing模型——经典的深度学习架构

3.1 Deep Crossing模型的应用场景
3.2 Deep Crossing模型的网络结构
3.3 Deep Crossing模型对特征交叉方法的革命

## 4 NeuralCF模型——CF与深度学习的结合

4.1 从深度学习的视角重新审视矩阵分解模型
4.2 NeuralCF模型的结构
4.3 NeuralCF模型的优势和局限性

## 5 PNN模型——加强特征交叉能力

5.1 PNN模型的网络架构
5.2 Product层的多种特征交叉方式
5.3 PNN模型的优势和局限性

## 6 Wide&Deep 模型——记忆能力和泛化能力的综合

6.1 模型的记忆能力与泛化能力
6.2 Wide&Deep模型的结构
6.3 Wide&Deep模型的进化——Deep&Cross模型
6.4 Wide&Deep模型的影响力

## 7 FM与深度学习模型的结合

7.1 FNN——用FM的隐向量完成Embedding层初始化
7.2 DeepFM——用FM代替Wide部分
7.3 NFM——FM的神经网络化尝试
7.4 基于FM的深度学习模型的优点和局限性

## 8 注意力机制在推荐模型中的应用

8.1 AFM——引入注意力机制的FM
8.2 DIN——引入注意力机制的深度学习网络
8.3 注意力机制对推荐系统的启发

## 9 DIEN——序列模型与推荐系统的结合

9.1 DIEN的“进化”动机
9.2 DIEN模型的架构
9.3 兴趣抽取层的结构
9.4 兴趣进化层的结构
9.5 序列模型对推荐系统的启发

## 10 强化学习与推荐系统的结合

10.1 深度强化学习推荐系统框架
10.2 深度强化学习推荐模型
10.3 DRN的学习过程
10.4 DRN的在线学习方法——竞争梯度下降算法
10.5 强化学习对推荐系统的启发

## 11 总结——推荐系统的深度学习时代

# 第4章 Embedding技术在推荐系统中的应用

## 1 什么是Embedding

1.1 词向量的例子
1.2 Embedding 技术在其他领域的扩展
1.3 Embedding 技术对于深度学习推荐系统的重要性

## 2 Word2vec——经典的Embedding方法

2.1 什么是Word2vec
2.2 Word2vec模型的训练过程
2.3 Word2vec的“负采样”训练方法
2.4 Word2vec对Embedding技术的奠基性意义

## 3 Item2vec——Word2vec 在推荐系统领域的推广

3.1 Item2vec的基本原理
3.2 “广义”的Item2vec
3.3 Item2vec方法的特点和局限性

## 4 Graph Embedding——引入更多结构信息的图嵌入技术

4.1 DeepWalk——基础的Graph Embedding方法
4.2 Node2vec——同质性和结构性的权衡
4.3 EGES——阿里巴巴的综合性Graph Embedding方法

## 5 Embedding与深度学习推荐系统的结合

5.1 深度学习网络中的Embedding层
5.2 Embedding的预训练方法
5.3 Embedding作为推荐系统召回层的方法

## 6 局部敏感哈希——让Embedding插上翅膀的快速搜索方法

6.1 “快速”Embedding近邻搜索
6.2 局部敏感哈希的基本原理
6.3 局部敏感哈希多桶策略

## 7 总结——深度学习推荐系统的核心操作

# 第5章 多角度审视推荐系统

## 1 推荐系统的特征工程

1.1 构建推荐系统特征工程的原则
1.2 推荐系统中的常用特征
1.3 常用的特征处理方法
1.4 特征工程与业务理解

## 2 推荐系统召回层的主要策略

2.1 召回层和排序层的功能特点
2.2 多路召回策略
2.3 基于Embedding的召回方法

## 3 推荐系统的实时性

3.1 为什么说推荐系统的实时性是重要的
3.2 推荐系统“特征”的实时性
3.3 推荐系统“模型”的实时性
3.4 用“木桶理论”看待推荐系统的迭代升级

## 4 如何合理设定推荐系统中的优化目标

4.1 YouTube以观看时长为优化目标的合理性
4.2 模型优化和应用场景的统一性
4.3 优化目标是和其他团队的接口性工作

## 5 推荐系统中比模型结构更重要的是什么

5.1 有解决推荐问题的“银弹”吗
5.2 Netflix对用户行为的观察
5.3 观察用户行为，在模型中加入有价值的用户信息
5.4 DIN模型的改进动机
5.5 算法工程师不能只是一个“炼金术士”

## 6 冷启动的解决办法

6.1 基于规则的冷启动过程
6.2 丰富冷启动过程中可获得的用户和物品特征
6.3 利用主动学习、迁移学习和“探索与利用”机制
6.4 “巧妇难为无米之炊”的困境

## 7 探索与利用

7.1 传统的探索与利用方法
7.2 个性化的探索与利用方法
7.3 基于模型的探索与利用方法
7.4 “探索与利用”机制在推荐系统中的应用

# 第6章 深度学习推荐系统的工程实现

## 1 推荐系统的数据流

1.1 批处理大数据架构
1.2 流计算大数据架构
1.3 Lambda架构
1.4 Kappa架构
1.5 大数据平台与推荐系统的整合

## 2 推荐模型离线训练之Spark MLlib

2.1 Spark的分布式计算原理
2.2 Spark MLlib的模型并行训练原理
2.3 Spark MLlib并行训练的局限性

## 3 推荐模型离线训练之Parameter Server

3.1 Parameter Server的分布式训练原理
3.2 一致性与并行效率之间的取舍
3.3 多server节点的协同和效率问题
3.4 Parameter Server技术要点总结

## 4 推荐模型离线训练之TensorFlow

4.1 TensorFlow的基本原理
4.2 TensorFlow基于任务关系图的并行训练过程
4.3 TensorFlow的单机训练与分布式训练模式
4.4 TensorFlow技术要点总结

## 5 深度学习推荐模型的上线部署

5.1 预存推荐结果或Embedding结果
5.2 自研模型线上服务平台
5.3 预训练Embedding+轻量级线上模型
5.4 利用PMML转换并部署模型
5.5 TensorFlow Serving
5.6 灵活选择模型服务方法

## 6 工程与理论之间的权衡

6.1 工程师职责的本质
6.2 Redis容量和模型上线方式之间的权衡
6.3 研发周期限制和技术选型的权衡
6.4 硬件平台环境和模型结构间的权衡
6.5 处理好整体和局部的关系

# 第7章 推荐系统的评估

## 1 离线评估方法与基本评价指标

1.1 离线评估的主要方法
1.2 离线评估的指标

## 2 直接评估推荐序列的离线指标

2.1 P-R曲线
2.2 ROC曲线
2.3 平均精度均值
2.4 合理选择评估指标

## 3 更接近线上环境的离线评估方法——Replay

3.1 模型评估的逻辑闭环
3.2 动态离线评估方法
3.3 Netflix的Replay评估方法实践

## 4 A/B测试与线上评估指标

4.1 什么是A/B测试
4.2 A/B测试的“分桶”原则
4.3 线上A/B测试的评估指标

## 5 快速线上评估方法——Interleaving

5.1 传统A/B测试存在的统计学问题
5.2 Interleaving方法的实现
5.3 Interleaving方法与传统A/B测试的灵敏度比较
5.4 Interleaving方法指标与A/B测试指标的相关性
5.5 Interleaving方法的优点与缺点

## 6 推荐系统的评估体系

# 第8章 深度学习推荐系统的前沿实践

## 1 Facebook的深度学习推荐系统

1.1 推荐系统应用场景
1.2 以GBDT+LR组合模型为基础的CTR预估模型
1.3 实时数据流架构
1.4 降采样和模型校正
1.5 Facebook GBDT+LR组合模型的工程实践
1.6 Facebook的深度学习模型DLRM
1.7 DLRM模型并行训练方法
1.8 DLRM模型的效果
1.9 Facebook深度学习推荐系统总结

## 2 Airbnb基于Embedding的实时搜索推荐系统

2.1 推荐系统应用场景
2.2 基于短期兴趣的房源Embedding方法
2.3 基于长期兴趣的用户Embedding和房源Embedding
2.4 Airbnb搜索词的Embedding
2.5 Airbnb的实时搜索排序模型及其特征工程
2.6 Airbnb实时搜索推荐系统总结

## 3 YouTube深度学习视频推荐系统

3.1 推荐系统应用场景
3.2 YouTube推荐系统架构
3.3 候选集生成模型
3.4 候选集生成模型独特的线上服务方法
3.5 排序模型
3.6 训练和测试样本的处理
3.7 如何处理用户对新视频的偏好
3.8 YouTube深度学习视频推荐系统总结

## 4 阿里巴巴深度学习推荐系统的进化

4.1 推荐系统应用场景
4.2 阿里巴巴的推荐模型体系
4.3 阿里巴巴深度学习推荐模型的进化过程
4.4 模型服务模块的技术架构
4.5 阿里巴巴推荐技术架构总结

# 第9章 构建属于你的推荐系统知识框架

## 1 推荐系统的整体知识架构图

## 2 推荐模型发展的时间线

## 3 如何成为一名优秀的推荐工程师

3.1 推荐工程师的4项能力
3.2 能力的深度和广度
3.3 推荐工程师的能力总结

# 后记

从开始写作本书到最终结稿，整整花了一年的时间。在这一年中，深度学习推荐系统的发展从未停歇，即便几次调整本书所包括知识的范围，力图跟上推荐系统技术发展的脚步，仍无法囊括所有最新的进展。就像笔者经常向别人介绍自己工作时所说的那样，“推荐工程师是一份挣扎在随时被淘汰边缘的工作”。所以当你合上本书时，这不是结束，而是另一个开始。

情况也没那么悲观，就像第9章开头介绍的，一旦建立起自己的推荐系统知识体系，剩下的就是在这棵大树上开枝散叶。笔者相信深度学习改变推荐系统的进程远没有结束，之前沉淀下来的经典模型终将成为知识大树上的重要节点，让大家一直受益，也希望本书能成为这棵大树的一个阶段性画像。对笔者来说，这也肯定不是结束，在不远的将来，笔者会持续更新书中的内容，让本书的知识体系同样枝繁叶茂，期待到时再次与你交流。