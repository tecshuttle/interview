# 序

2017年，知道刘博文在写书。

2018年年初，博文加入Web性能工作组，几乎每周的例会上，我都会问问博文新书写作和出版的进度。

时值年末，这本书终于要出版了。

两周来，我利用空暇时间大致浏览了一遍书稿。我想，等到手头的项目开发告一段落之后，一定要抽时间重新研读两遍。没错，这本书至少要读两遍以上。

刘博文写这本书的初衷就是把自己研究Vue.js源码的心得分享出来。



## 第1章 Vue.js简介

### 1 什么是Vue.js

它是目前所有主流框架中学习曲线最平缓的框架，非常容易上手，其官方文档也写得非常清晰、易懂。

### 2 Vue.js简史

最早的Vue.js只做视图层，没有路由，没有状态管理，也没有官方的构建工具，只有一个库，放在网页里就直接用。

后来，他发现Vue.js无法用在一些大型应用上，这样在开发不同大小的应用时，需要不停地切换框架以及思维模式。尤雨溪希望有一个方案，有足够的灵活性，能够适应不同大小的应用需求。

所以，Vue.js就慢慢开始加入了一些官方的辅助工具，比如路由（Router）、状态管理方案（Vuex）和构建工具（vue-cli）等。

加入这些工具时，Vue.js始终维持着一个理念：“这个框架应该是渐进式的”。

所谓渐进式框架，就是把框架分层。视图层渲染、组件机制、路由机制、状态管理、构建工具。

所谓分层，就是说你既可以只用最核心的视图层渲染功能来快速开发一些需求，也可以使用一整套全家桶来开发大型应用。Vue.js有足够的灵活性来适应不同的需求，所以你可以根据自己的需求选择不同的层级。

除了引入虚拟DOM外，Vue.js 2.0还提供了很多令人激动的特性，比如支持JSX和TypeScript，支持流式服务端渲染，提供了跨平台的能力等。

# 第一篇 变化侦测

Vue.js最独特的特性之一是看起来并不显眼的响应式系统。

从状态生成DOM，再输出到用户界面显示的一整套流程叫作渲染。变化侦测是响应式系统的核心，没有它，就没有重新渲染。

学完本篇，你将可以自己实现一个变化侦测的功能。

## 第2章 Object的变化侦测

大部分人不会想到Object和Array的变化侦测采用不同的处理方式。

### 1 什么是变化侦测

### 2 如何追踪变化

学过JavaScript的人都知道，有两种方法可以侦测到变化：使用Object.defineProperty和ES6的Proxy。

由于使用Object.defineProperty来侦测变化会有很多缺陷，所以Vue.js的作者尤雨溪说日后会使用Proxy重写这部分代码。

### 3 如何收集依赖

### 4 依赖收集在哪里

5 依赖是谁
6 什么是Watcher
7 递归侦测所有key
8 关于Object的问题
9 总结

## 第3章 Array的变化侦测

Vue侦测数组变化的原理 https://blog.csdn.net/weixin_43737327/article/details/112350308

```js
this.list.push(1);
```

使用push方法来改变数组，并不会触发getter/setter。

### 1 如何追踪变化

### 2 拦截器

### 3 使用拦截器覆盖Array原型

4 将拦截器方法挂载到数组的属性上
5 如何收集依赖
6 依赖列表存在哪儿
7 收集依赖
8 在拦截器中获取Observer实例
9 向数组的依赖发送通知

### 10 侦测数组中元素的变化

[vue 中 watch如何监听数组或对象中的某个值?](https://blog.csdn.net/qq_28143153/article/details/109812687)

- 数组自身的变化 ，比如是否新增一个元素，是否删除一个元素等。
- 当数组中object身上某个属性的值发生了变化时，也需要发送通知。
- 如果用户使用了push往数组中新增了元素，这个新增元素的变化也需要侦测。

### 11 侦测新增元素的变化

#### 获取新增元素

#### 使用Observer侦测新增元素

### 12 关于Array的问题

```js
this.list[0]=2;
this.list.length = 0;
```

这两个操作，在ES6前无法拦截原型，使用Proxy可以做到。

### 13 总结

## 第4章 变化侦测相关的API实现原理

### 1 `vm.$watch`

用法
watch的内部原理
deep参数的实现原理

### 2 `vm.$set`

用法

Array的处理

key已经存在于target中

处理新增的属性

### 3 `vm.$delete`

由于Vue.js的变化侦测是使用Object.defineProperty实现的，所以如果数据是使用delete关键字删除的，那么无法发现数据发生了变化。为了解决这个问题，Vue.js提供了vm.$delete方法来删除数据中的某个属性，并且此时Vue.js可以侦测到数据发生了变化。

#### 用法

#### 实现原理

### 4 总结

# 第二篇 虚拟DOM

## 第5章 虚拟DOM简介

1 什么是虚拟DOM
2 为什么要引入虚拟DOM
3 Vue.js中的虚拟DOM
4 总结

## 第6章 VNode

1 什么是VNode
2 VNode的作用
3 VNode的类型
注释节点
文本节点
克隆节点
元素节点
组件节点
函数式组件
4 总结

## 第7章 patch

1 patch介绍
新增节点
删除节点
更新节点
小结
2 创建节点
3 删除节点
4 更新节点
静态节点
新虚拟节点有文本属性
新虚拟节点无文本属性
小结
5 更新子节点
更新策略
优化策略
哪些节点是未处理过的
小结
6 总结

# 第三篇 模板编译原理

## 第8章 模板编译

1 概念
2 将模板编译成渲染函数
解析器
优化器
代码生成器
3 总结

## 第9章 解析器

1 解析器的作用
2 解析器内部运行原理
3 HTML解析器
运行原理
截取开始标签
截取结束标签
截取注释
截取条件注释
截取DOCTYPE
截取文本
纯文本内容元素的处理
使用栈维护DOM层级
整体逻辑
4 文本解析器
5 总结

## 第10章 优化器

1 找出所有静态节点并标记
2 找出所有静态根节点并标记
3 总结

## 第11章 代码生成器

1 通过AST生成代码字符串
2 代码生成器的原理
元素节点
文本节点
注释节点
3 总结

# 第四篇 整体流程

## 第12章 架构设计与项目结构

### 1 目录结构

### 2 架构设计

3 总结

## 第13章 实例方法与全局API的实现原理

### 1 数据相关的实例方法

### 2 事件相关的实例方法

vm.$on
vm.$off
vm.$once
vm.$emit

### 3 生命周期相关的实例方法

vm.$forceUpdate
vm.$destroy
vm.$nextTick
vm.$mount

### 4 全局API的实现原理

Vue.extend
Vue.nextTick
Vue.set
Vue.delete
Vue.directive
Vue.filter
Vue.component
Vue.use
Vue.mixin
Vue.compile
Vue.version

5 总结

## 第14章 生命周期

### 1 生命周期图示

初始化阶段
模板编译阶段
挂载阶段
卸载阶段
小结

### 2 从源码角度了解生命周期

### 3 errorCaptured与错误处理

### 4 初始化实例属性

### 5 初始化事件

### 6 初始化inject

provide/inject的使用方式
inject的内部原理

### 7 初始化状态

初始化props
初始化methods
初始化data
初始化computed
初始化watch

### 8 初始化provide

9 总结

## 第15章 指令的奥秘

### 1 指令原理概述

v-if指令的原理概述
v-for指令的原理概述
v-on指令

### 2 自定义指令的内部原理

### 3 虚拟DOM钩子函数

4 总结

## 第16章 过滤器的奥秘

### 1 过滤器原理概述

串联过滤器
滤器接收参数
resolveFilter的内部原理

### 2 解析过滤器

3 总结

## 第17章 最佳实践

### 1 为列表渲染设置属性key

### 2 在v-if/v-if-else/v-else中使用key

### 3 路由切换组件不变

路由导航守卫beforeRouteUpdate
观察
为router-view组件添加属性key

### 4 为所有路由统一添加query

使用全局守卫beforeEach
使用函数劫持

### 5 区分Vuex与props的使用边界

### 6 避免v-if和v-for一起使用

### 7 为组件样式设置作用域

### 8 避免在scoped中使用元素选择器

### 9 避免隐性的父子组件通信

### 10 单文件组件如何命名

单文件组件的文件名的大小写
基础组件名
单例组件名
紧密耦合的组件名
组件名中的单词顺序
完整单词的组件名
组件名为多个单词
模板中的组件名大小写
JS/JSX中的组件名大小写

### 11 自闭合组件

### 12 prop名的大小写

### 13 多个特性的元素

### 14 模板中简单的表达式

### 15 简单的计算属性

### 16 指令缩写

### 17 良好的代码顺序

组件/实例的选项的顺序
元素特性的顺序
单文件组件顶级元素的顺序
18 总结

